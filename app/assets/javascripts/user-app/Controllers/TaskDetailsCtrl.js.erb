'use strict';
angular.module('pyramidApp')
	.controller('TaskDetailsCtrl',['$scope', '$routeParams', 'Tasks', '$interval', 'GetInf', 'GetOutputs', 'Templates', '$http', '$location', function($scope, $routeParams, Tasks, $interval, GetInf, GetOutputs, Templates, $http, $location){
		var refreshTimer;
		$scope.taskId = $routeParams.taskId;
		$scope.getInf = function(){
			combiner();
			refreshTimer = $interval(combiner, 2000);
		}
		$scope.$on("$destroy", function(){
    		$scope.stopInterval();
		});
	 	$scope.stopInterval = function() {
      		if (angular.isDefined(refreshTimer)) {
        		$interval.cancel(refreshTimer);
        		refreshTimer = undefined;
      		}
    	};
    	$scope.removeTask = function(){
		  Tasks.remove({id: $scope.taskId}, function() {
        	});		
		};
		$scope.stopTask = function(typeDell){
			var res = $http.post('/user_app/tasks/:id/dell_task/:params', {name: 'Head', password: 'user', type_dell: typeDell, 'task_name': $scope.task.name});
			res.success(function(data, status, headers, config) {
			});
		};
		function combiner(){
			GetInf.get({name: 'Head', password: 'user'});
			Tasks.get({id: $scope.taskId}, function(resp){
				$scope.task = resp;		
				var work_stat = $scope.task.work_status.split('\"');

				$scope.task.compite_work = work_stat[work_stat.indexOf('Completed work:') + 3].replace("\\","");
				$scope.task.in_work = work_stat[work_stat.indexOf('Parts in work:') + 3].replace("\\","");
				$scope.task.remained_work =	work_stat[work_stat.indexOf('Remained work:') + 3].replace("\\","");

				$scope.task.compiled = $scope.task.compite_work.split(' ');
				$scope.task.remained = $scope.task.remained_work.split(' ');
				$scope.task.compiledSum = 0;
				$scope.task.remainedSum = 0;
				for(var i in $scope.task.compiled){
					if(i%2 == 1)
						$scope.task.compiledSum += parseInt($scope.task.compiled[i]);
				}
				for(var i in $scope.task.remained){
					if(i%2 == 1)
						$scope.task.remainedSum += parseInt($scope.task.remained[i]);
				}
				if($scope.task.status_suppz == 'queue'){
					$scope.queuePeriod = $scope.task.mqinfo.split('~')[1].split(' ')[0];
					$scope.startTime = $scope.task.mqinfo.split('<:')[1];
				}
				if($scope.task.status_suppz == 'run'){
					$scope.timeToFinish = $scope.task.mqinfo.split(' ')[22];
					$scope.finishTime = $scope.task.mqinfo.split('>:')[1];
				}
				if($scope.task.status_suppz == 'block'){
					$scope.blockFlag = $scope.task.mqinfo.split('~~~')[0].split(' ');
					$scope.timeToStartBlock = $scope.blockFlag[$scope.blockFlag.length - 1];
					$scope.startTimeBlock = $scope.task.mqinfo.split('>:')[1];
				}
				if($scope.task.status_suppz == 'finished'){
					//$scope.blockFlag = $scope.task.mqinfo.split('~~~')[0].split(' ');
					//$scope.blockFlag = $scope.blockFlag[$scope.blockFlag.length - 1];
					//$scope.startTimeFin = $scope.task.mqinfo.split('>:')[1];
				}
			},function(){
				$location.path('/tasks');
			});
		}
	}]);